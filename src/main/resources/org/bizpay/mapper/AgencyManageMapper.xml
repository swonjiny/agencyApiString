<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="org.bizpay.mapper.AgencyManageMapper">
  	<!-- 대리점목록 -->
  	<select id="agencyList" resultType="AgencyManage" >
				select a.bizrno, a.cmpnm, a.trmnl_no, a.pg_trmnl_no, a.pg_van, a.pay_bprprr, a.pay_telno, a.pay_cmpnm, a.pay_bizrno, a.pay_bplc
						, a.m_telno, a.email, a.bank_name, a.bank_serial, a.create_dt, a.bank_user, a.dealer_rate, a.member_input_yn, a.member_rate, a.memo, a.history_memo
				        , a.join_amt, a.limit_one, a.limit_day, a.limit_month, a.limit_year, a.installment_months
				        , a.biz_limit_one, a.biz_limit_day, a.biz_limit_month, a.biz_limit_year, a.biz_installment_months
				        , a.pg_gb, a.van_gb, a.biz_type
							, b.usid, b.mber_code, b.biz_code, a.bprprr, a.bplc, a.biz_telno, a.pymnt_rate, a.dealer_id, a.dt, a.trget_biz_code, a.recommend_biz_code, a.baro_rate, a.etc_rate, a.dealer_kind, 
				(SELECT code_nm FROM code WHERE group_nm = '대리점구분' AND sn = nvl(a.dealer_kind, (SELECT MAX(sn) FROM code WHERE group_nm = '대리점구분'))) as gubun,
				(SELECT cmpnm FROM biz WHERE biz_code = a.trget_biz_code) as target,
				(SELECT cmpnm FROM biz WHERE biz_code = a.recommend_biz_code) as recommend, 	
				GET_AGENCY(a.trget_biz_code, a.dealer_kind) as agent,
				GET_DISTRIBUTOR(a.trget_biz_code, a.dealer_kind) as distributor,
				(SELECT COUNT(*) FROM mber WHERE biz_code=b.biz_code AND author_code NOT IN('AUTHOR_MNGR','AUTHOR_DEALER')) AS mber_cnt, 
				Nvl((SELECT hist_cn FROM mber_hist2 WHERE mber_code=b.mber_code AND sn=(SELECT MAX(sn) FROM mber_hist2 WHERE mber_code=b.mber_code AND hist_code='MH_USE_AT')) , 'N') as use_at, 
				(SELECT creat_dt FROM mber_hist2 WHERE mber_code=b.mber_code AND sn=(SELECT MAX(sn) FROM mber_hist2 WHERE mber_code=b.mber_code AND hist_code='MH_USE_AT')) as creat_dt 
				FROM biz a, mber b
				WHERE a.biz_code=b.biz_code
		  		<if test="cmpnm!=null and !cmpnm.equals('')"> 
                	AND A.cmpnm= #{cmpnm}
                </if>
                <if test="dealerId!=null and !dealerId.equals('')"> 
                	AND A.dealer_id= #{dealerId}
                </if>
                <if test="useAt!=null and !useAt.equals('')"> 
                	AND b.use_at= #{useAt}
                </if>
				<if test="bizNum!=null and !bizNum.equals('')"> <!-- 암호화해서 비교해야 한다. -->
                	AND b.bizrno= #{bizNum}
                </if>
		
				AND b.author_code in('AUTHOR_MNGR','AUTHOR_DEALER') 
				AND a.biz_code in (SELECT biz_code FROM biz START WITH biz_code = #{memberBizeCode} CONNECT BY NOCYCLE PRIOR biz_code = trget_biz_code) 
				ORDER BY b.biz_code DESC 
		

  	</select>
  	
  	<update id="updateBiz">
  	UPDATE BIZ
		SET 
		    BIZRNO                 = #{bizrno}, <!-- 필수 :  암호화후저장  --> 
		    DEALER_ID              = #{dealerId}, 
		    CMPNM                  = #{cmpnm}, 
		    BPRPRR                 =  #{bprprr}, 
		    BPLC                   = #{bprprr} , 
		    BIZ_TELNO              = #{bizTelno}, 
		    
		    <!--  HEADOFFICE -->
		    TRMNL_NO            = #{trmnlNo}, 
		    PG_TRMNL_NO       = #{pgTrmnlNo}, 
		    PG_VAN                = #{pgVan},
		    PG_GB                  = #{pgGb}, 
		    VAN_GB                = #{vanGb},
		    BIZ_TYPE               = #{bizType}, 
		    <!--end !HEADOFFICE -->
		   
		    DEALER_KIND            = #{dealerKind}, 		    
   			TRGET_BIZ_CODE        = #{trgetBizCode}, 
	  		RECOMMEND_BIZ_CODE     = #{recommendBizCode},
	  		PAY_BPRPRR             = #{payBprprr}, 
	  		PAY_TELNO              = #{payTelno}, 
	  		PAY_CMPNM              = #{payCmpnm}, 
	  		PAY_BIZRNO             = #{payBizrno}, 
	  		PAY_BPLC               = #{payBplc},
	  		M_TELNO                = #{mTelno}, 
	  		EMAIL                  = #{email},
	  		BANK_NAME              = #{bankName},
	  		BANK_SERIAL            = #{bankSerial},
	  		BANK_USER              = #{bankUser}, 
	  		DEALER_RATE            = #{dealerRate}, 
	  		MEMBER_INPUT_YN        = #{memberInputYn}, 
	  		MEMBER_RATE            = #{memberRate},
	  		MEMO                   = #{memo}, 
		    HISTORY_MEMO           = #{historyMemo}, 
	  		LIMIT_ONE              = #{limitOne}, 
		    LIMIT_DAY              = #{limitDay}, 
		    LIMIT_MONTH            = #{limitMonth}, 
		    LIMIT_YEAR             = #{limitYear}, 
		    INSTALLMENT_MONTHS     = #{installmentMonths}, 
		    BIZ_LIMIT_ONE          = #{bizLimitOne}, 
		    BIZ_LIMIT_DAY          = #{bizLimitDay}, 
		    BIZ_LIMIT_MONTH        = #{bizLimitMonth}, 
		    BIZ_LIMIT_YEAR         = #{bizLimitYear}, 
		    BIZ_INSTALLMENT_MONTHS = #{bizInstallmentMonths},
		    JOIN_AMT               = #{joinAmt}, 		   
		    DT                     = SYSDATE
		WHERE BIZ_CODE     = #{bizCode}		 
  	</update>
  	<!--  존재하는 대리점인지 확인 -->
  	<select id="bizCount" resultType="int">
  	SELECT count(1) FROM biz WHERE biz_code= #{val}
  	</select>
  	
	<!-- 하위대리점에 속하는 대리점인지 확인 -->
	<select id="agencyConfirm1" resultType="int">
		SELECT nvl(min(dealer_kind), 0) as minDealerKind
		FROM ( SELECT biz_code, nvl(dealer_kind, (SELECT max(sn) FROM code WHERE group_nm = '대리점구분')) as dealer_kind FROM biz START WITH biz_code =  #{bizCode} CONNECT BY NOCYCLE PRIOR biz_code = trget_biz_code ) a 
		WHERE a.biz_code != #{val}
	</select>
	
	<!-- trget_biz_code -->
	<select id="agencyConfirm2" resultType="int">
		SELECT dealer_kind FROM biz WHERE biz_code = #{val} 
	</select>
	<!-- agent member_biz_code -->
	<select id="agencyConfirm3" resultType="int">
		SELECT dealer_kind FROM biz WHERE biz_code = ( SELECT trget_biz_code FROM biz WHERE biz_code = #{val} )
	</select>
	
	<insert id="insertBizHist">
	insert into
    BIZ_HIST (
        BIZ_CODE,
        SN,
        BIZRNO,
        CMPNM,
        BPRPRR,
        BPLC,
        BIZ_TELNO,
        TRMNL_NO,
        PG_TRMNL_NO,
        PG_VAN,
        CREAT_MBER_CODE,
        DEALER_KIND,
        PAY_BPRPRR,
        PAY_TELNO,
        PAY_CMPNM,
        PAY_BIZRNO,
        PAY_BPLC,
        M_TELNO,
        EMAIL,
        BANK_NAME,
        BANK_SERIAL,
        BANK_USER,
        DEALER_RATE,
        MEMBER_INPUT_YN,
        MEMBER_RATE,
        MEMO,
        HISTORY_MEMO,
        LIMIT_ONE,
        LIMIT_DAY,
        LIMIT_MONTH,
        LIMIT_YEAR,
        INSTALLMENT_MONTHS,
        BIZ_LIMIT_ONE,
        BIZ_LIMIT_DAY,
        BIZ_LIMIT_MONTH,
        BIZ_LIMIT_YEAR,
        BIZ_INSTALLMENT_MONTHS,
        PG_GB,
        VAN_GB,
        BIZ_TYPE,
        JOIN_AMT
    )
	values
    (
       #{bizCode},
       (SELECT nvl( MAX(sn)+1 , 1)  FROM biz_hist WHERE biz_code=#{bizCode}),
       #{bizrno},
       #{cmpnm},
       #{bprprr},
       #{bplc},
       #{bizTelno},
       #{trmnlNo},
       #{pgTrmnlNo},
       #{pgVan},
       #{creatMberCode},
       #{dealerKind},
       #{payBprprr},
       #{payTelno},
       #{payCmpnm},
       #{payBizrno},
       #{payBplc},
       #{mTelno},
       #{email},
       #{bankName},
       #{bankSerial},
       #{bankUser},
       #{dealerRate},
       #{memberInputYn},
       #{memberRate},
       #{memo},
       #{historyMemo},
       #{limitOne},
       #{limitDay},
       #{limitMonth},
       #{limitYear},
       #{installmentMonths},
       #{bizLimitOne},
       #{bizLimitDay},
       #{bizLimitMonth},
       #{bizLimitYear},
       #{bizInstallmentMonths},
       #{pgGb},
       #{vanGb},
       #{bizType},
       #{joinAmt}
    )
	
	</insert>
	
	<insert id="insertBiz">
		INSERT INTO biz (
			biz_code,
			bizrno,
			cmpnm,
			bprprr,
			bplc,
			biz_telno,
			trmnl_no,
			pymnt_rate,
			dealer_id,
			trget_biz_code,-- 널인경우 뺀다
			recommend_biz_code,
			trget_biz_code ,
			dealer_kind,
			pay_bprprr,
			pay_telno,
			pay_cmpnm,
			pay_bizrno,
			pay_bplc,
			pg_van,
			pg_trmnl_no,
			m_telno,
			email,
			bank_name,
			bank_serial,
			bank_user,
			dealer_rate,
			member_input_yn,
			member_rate,
			limit_one,
			limit_day,
			limit_month,
			limit_year,
			installment_months,
			biz_limit_one,
			biz_limit_day,
			biz_limit_month,
			biz_limit_year,
			biz_installment_months,
			pg_gb,
			van_gb,
			biz_type,
			create_dt,
			join_amt
		) VALUES (
			#{biz_code} , -- 코드추출용 로직 필요
			#{bizrno},
			#{cmpnm}, 
			#{bprprr}, -- 사업주냐 개인이냐에 따라 달라진다. 사업주 - bprprr  개인 -cmpnm
			#{bplc},
			#{biz_telno},
			#{trmnl_no},
			#{pymnt_rate},
			#{dealer_id},
			#{trget_biz_code},
			#{recommend_biz_code},
			#{trget_biz_code},
			#{dealer_kind},
			#{pay_bprprr},
			#{pay_telno},
			#{pay_cmpnm},
			#{pay_bizrno},
			#{pay_bplc},
			#{pg_van},
			#{pg_trmnl_no},
			#{m_telno},
			#{email},
			#{bank_name},
			#{bank_serial},
			#{bank_user},
			#{dealer_rate},
			#{member_input_yn},
			#{member_rate},
			#{limit_one},
			#{limit_day},
			#{limit_month},
			#{limit_year},
			#{installment_months},
			#{biz_limit_one},
			#{biz_limit_day},
			#{biz_limit_month},
			#{biz_limit_year},
			#{biz_installment_months},
			#{pg_gb},
			#{van_gb},
			#{biz_type},
			to_char(sysdate , 'YYYY-MM-DD' ),
			#{join_amt}
			)
		
	</insert>
	
	<select id="selectBizCode" resultType="int">
		SELECT NVL(MAX(biz_code)+1,1)  FROM biz
	</select>
	
	<select id="selectBizCount" resultType="int">
		SELECT count(1) FROM biz WHERE bizrno = #{val}
	</select>
	
	<!-- 대리점 목록 -->
	<select id="selectSellerList" resultType="SellerList" >
	select * from
	(select
	    b.induty_id,
	    b.memo,
	    b.history_memo,
	    b.adres,
	    b.mbtlnum,
	    b.mber_code,
	    a.biz_code,
	    a.recommend_biz_code as b_recommend_biz_code,
	    nvl(b.calculate_type , 'U' ) as calculate_type,
	    a.cmpnm,
	    b.fee_rate,
	    b.creat_dt,
	    nvl(b.reg_case ,'대리점' ) as reg_case,
	    b.mber_mobile,
	    b.mber_phone,
	    b.mber_name,
	    b.mber_jumi,
	    b.bank_name,
	    bank_code,
	    b.account_no,
	    b.email,
	    b.depositor,
	    b.atm_stop,
	    b.pay_type,
	    case pay_type when 'N' then '일반' else (case pay_type when 'B' then '바로정산' else '익일입금' end) end as kpay_type,
	    b.code_rate,
	    b.one_limit_rate,
	    b.recommend_biz_code,
	    b.document_reg,
	    b.lv1_rate,
	    b.lv2_rate,
	    b.lv3_rate,
	    b.fee_distributor,
	    b.fee_agency,
	    b.fee_dealer,
	    b.fee_bank,
	    (select hist_cn from mber_hist2 where mber_code = b.mber_code and sn = (select max(sn) from mber_hist2 where mber_code = b.mber_code and hist_code = 'MH_USE_AT')) as use_at,
	    (select creat_dt from mber_hist2 where mber_code = b.mber_code and sn = ( select max(sn) from mber_hist2 where mber_code = b.mber_code and hist_code = 'MH_USE_AT')) as creat_dt_can,
	    b.limit_one,
	    b.limit_day,
	    b.limit_month,
	    b.limit_year,
	    b.trmnl_no,
	    b.pg_trmnl_no,
	    b.pg_sugi_trmnl_no,
	    nvl(b.pg_van , 'VAN' ) as pg_van,
	    b.pg_gb,
	    b.van_gb,
	    nvl(b.set_device , '') as set_device,
	    nvl(b.sugi , 'N' ) as sugi,
	    nvl(b.sugi_certification , 'N' ) as sugi_certification,
	    nvl(b.sms_autosend ,'N') as sms_autosend,
	    nvl(b.set_sms_auth,'N') as set_sms_auth,
	    b.sms_auth_money,
	    b.biz_type_name,
	    b.biz_item,
	    nvl(b.cash_trmnl_no , '') as cash_trmnl_no,
	    b.installment_months,
	    b.biz_type,
	    b.company_name,
	    b.biz_num,
	    (select balance from tbl_atm 
		    where mber_code = b.mber_code and req_result = 'OK' and inout_no = (
	                select max(inout_no)from tbl_atm where mber_code = b.mber_code and req_result = 'OK'
	            )
	    ) as balance,
	    (select dealer_id from biz where biz_code = b.biz_code) as dealer_id,
	    (select dealer_kind from biz where biz_code = b.biz_code) as dealer_kind,
	    (select dealer_rate from biz where biz_code = b.biz_code) as dealer_rate
	from
	    biz a,
	    mber_basis b
	where
	    a.biz_code = b.biz_code
	    and a.biz_code in (
	        select biz_code from biz
	        start with biz_code = '0000002'
	        connect by nocycle
	            prior biz_code = trget_biz_code
	    )
	    and b.mber_name is not null
	    <if test="bizCode!=null and !bizCode.equals('')">
			AND  a.biz_code=#{bizCode}
        </if>
        <if test="calculateType!=null and !calculateType.equals('')">
			AND b.calculate_type=#{calculateType}
        </if>
        <if test="indutyId!=null and !indutyId.equals('')">
			AND b.induty_id LIKE #{indutyId}
        </if>
        <if test="memberName!=null and !memberName.equals('')">
			AND b.mber_name LIKE '%'||#{memberName}||'%'
			
        </if>
        <if test="bizNum!=null and !bizNum.equals('')">
			AND b.biz_num like  '%'||#{bizNum}||'%'
        </if>
        <if test="depositor!=null and !depositor.equals('')">
			AND b.depositor LIKE '%'||#{depositor}||'%'
        </if>
        <if test="bizTypeName!=null and !bizTypeName.equals('')">
			AND b.biz_type_name LIKE '%'||#{bizTypeName}||'%'
        </if>
        <if test="bizItem!=null and !bizItem.equals('')">
			AND b.biz_item LIKE '%'||#{bizItem}||'%'
        </if>
 
        <if test="dateStart!=null and !dateStart.equals('')">
			AND TO_CHAR(b.creat_dt,'yyyymmdd') >= #{dateStart}
        </if>
        <if test="dateEnd!=null and !dateEnd.equals('')">
			AND TO_CHAR(b.creat_dt,'yyyymmdd') &lt;= #{dateEnd}
        </if>
        <if test="nm!=null and !nm.equals('')">
			AND b.company_name LIKE '%'||#{nm}||'%'
        </if>
        
        	<if test='useAt.equals("S")'>
			AND b.reg_case is null        	  
        	</if>
        	<if test='useAt.equals("T")'>
			AND b.reg_case  = 'APP'     	  
        	</if>
        	<if test='useAt.equals("U")'>
			AND b.document_reg = 'O'  	  
        	</if>
        	<if test='useAt.equals("V")'>
			AND b.document_reg != 'O' 
        	</if>
      
	    ORDER BY b.creat_dt DESC )
	    where 1=1 
		<choose>
			<when test='useAt!=null and  useAt.equals("Y") '>
				AND use_at='Y' OR use_at is null
			</when>
			<when test='useAt!=null and  useAt.equals("N") '>
				AND use_at='N' 
			</when>
			
		</choose>

	</select>

  </mapper>
