<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="org.bizpay.mapper.InqireDelngMapper">
  	<sql id="delng">
		AND d.biz_code in 
		 	(SELECT aaa.biz_code FROM biz aaa START WITH aaa.biz_code = #{memberBizeCode}
		 	CONNECT BY NOCYCLE PRIOR aaa.biz_code = aaa.trget_biz_code)
		 AND b.confm_dt between #{dateStart} and #{dateEnd}
		 
		 <if test="bizCode!='all'" >
		     AND c.biz_code=#{bizCode}
	     </if>
	     <if test="delngSeCode!='all'" >
	     	AND b.delng_se_code= #{delngSeCode}
	     </if>
	     <if test="calculateType!='all'" >
			AND e.calculate_type= #{calculateType}
	     </if>
	     
	     <if test="mberName!=null" >
			AND e.mber_name like '%'||#{mberName}||'%'
	     </if>
	     <if test="confmNo!=0" >
			AND b.confm_no= #{confmNo}
	     </if>
	     <if test="mberId!=null" >
			AND e.induty_id= #{mberId}
	     </if>
	     <if test="bizNum!=null" >
			AND a.biz_num like '%'||#{bizNum}||'%'
	     </if>
	     <if test="issueCmpnyNm!=null" >
			AND a.issue_cmpny_nm like '%'||#{issueCmpnyNm}||'%'
	     </if>
	     <if test="tot!=0" >
			AND b.splpc+bb.vat= #{tot}
	     </if>
	     <if test='badCardSearch=="Y"' >
			AND	a.card_no IN 
			( 
				SELECT card_no from  
				    ( 
			        SELECT bbi.card_no, count(bbi.card_no) as cnt 
			        FROM delng aai, delng_credt bbi  
			        WHERE aai.rcipt_no = bbi.rcipt_no  
			        	AND aai.mber_code = bbi.mber_code
						AND aai.confm_dt between #{dateStart} and #{dateEnd}
			        	AND aai.delng_se_code='CARD_ISSUE'  
			        	AND aai.splpc + aai.vat >= '300000'  
			        GROUP BY bbi.card_no 
				    ) 
			    WHERE cnt > 1 
			)
	     </if>
	</sql>
  <!--입출 내역 전체합  -->
	<select id="totInfo" resultType="InqireDelngSum">
	select 
		sum(b.splpc+b.vat) AS sum 
	    ,SUM(CASE WHEN DELNG_SE_CODE='CARD_ISSUE' THEN b.splpc+b.vat ELSE 0 END) AS card_sum
		,SUM(CASE WHEN DELNG_SE_CODE='CARD_ISSUE' THEN 1 ELSE 0 END) AS card_count
		,SUM(CASE WHEN DELNG_SE_CODE='CASH_RCIPT_ISSUE' THEN b.splpc+b.vat ELSE 0 END) AS cash_sum
		,SUM(CASE WHEN DELNG_SE_CODE='CASH_RCIPT_ISSUE' THEN 1 ELSE 0 END) AS cash_count
		from 
		  delng_credt a
		  right outer join delng b
		    on a.mber_code=b.mber_code
		    and a.mber_code_sn=b.mber_code_sn 
		    and a.rcipt_no=b.rcipt_no
		  inner join mber c
		    on b.mber_code=c.mber_code
		  inner join biz d
		    on c.biz_code=d.biz_code
		  right outer join mber_basis e
		    on c.mber_code=e.mber_code
		where b.CARD_DELETE_YN = 'N'
		 <include refid="delng" />
	</select>
	
	<!--입출 내역   -->
	<select id="list" resultType="InqireDelng" >
		SELECT 
			d.cmpnm,
			e.adres,
			e.biz_type_name,
			e.biz_item,
			d.trmnl_no,
			d.pg_trmnl_no,
			d.pg_van,
			c.usid, 
			case e.pay_type when 'N' then '일반' else ( case e.pay_type  when 'B' then '바로정산' else '익일입금' end ) end as payType, 
			b.rcipt_no,
			(SELECT adi_cn 
				FROM delng_adi 
				WHERE mber_code=b.mber_code 
					AND mber_code_sn=b.mber_code_sn 
					AND rcipt_no=b.rcipt_no 
					AND adi_code='PURCHSR_MBTLNUM') AS purchsrMbtlnum,
			b.splpc,
			b.vat,
			b.delng_se_code,
			a.card_type,
			a.instlmt_month,
			a.issue_cmpny_nm,
			a.card_no,
			a.pg_van_gb,
			a.van_pg_comp,
			b.confm_dt,
			b.confm_time,
			b.confm_no,
			b.sms_auth_number,
			b.good_nm,
			b.payment_device,
			(SELECT mbtlnum FROM mber_basis WHERE mber_code=c.mber_code) AS mbtlnum,
			(SELECT confm_dt 
				FROM delng 
				WHERE trget_mber_code=b.mber_code 
				    AND trget_mber_code_sn=b.mber_code_sn 
				    AND trget_rcipt_no=b.rcipt_no 
				    AND delng_se_code IN('CARD_CNCL','CASH_RCIPT_CNCL')) AS cnclConfmDt,
			(SELECT confm_time 
			    FROM delng 
			    WHERE trget_mber_code=b.mber_code 
			        AND trget_mber_code_sn=b.mber_code_sn 
			        AND trget_rcipt_no=b.rcipt_no 
			        AND delng_se_code IN('CARD_CNCL','CASH_RCIPT_CNCL')) AS cnclConfmTime,
			TO_CHAR(b.cancel_dt,'YYYY-MM-DD') AS cancel_dt,  
			b.bigo,  
			e.mber_name,  
			e.company_name,  
			e.biz_num,  
			e.mber_mobile, 
			e.mber_phone,
			e.calculate_type
			FROM delng b
		       left outer join delng_credt a
		       on a.mber_code=b.mber_code AND a.mber_code_sn=b.mber_code_sn AND a.rcipt_no=b.rcipt_no 
		       inner join mber c
		       on b.mber_code=c.mber_code 
		       inner join biz d
		       on c.biz_code=d.biz_code
		       right outer join mber_basis e 
		       on c.mber_code =e.mber_code 
			WHERE b.delng_se_code IN('CARD_ISSUE','CARD_CNCL','CASH_RCIPT_CNCL','CASH_RCIPT_ISSUE')
			<include refid="delng" />
			ORDER BY b.confm_dt DESC,b.confm_time DESC 
	</select>
	
	<!--입출 내역 페이징   -->
	<select id="pageList" resultType="InqireDelng" >
		SELECT 
			info.cmpnm,
			info.adres,
			info.biz_type_name,
			info.biz_item,
			info.trmnl_no,
			info.pg_trmnl_no,
			info.pg_van,
			info.usid,
			info.pay_type as payType,
			info.rcipt_no as rciptNo,
			info.purchsr_mbtlnum,
			info.splpc,
			info.vat,
			info.delng_se_code,
			info.card_type,
			info.instlmt_month ,
			info.issue_cmpny_nm,
			info.card_no,
			info.pg_van_gb,
			info.van_pg_comp,
			info.confm_dt,
			info.confm_time,
			info.confm_no,
			info.sms_auth_number,
			info.good_nm,
			info.payment_device,
			info.mbtlnum,
			info.cncl_confm_dt,
			info.cncl_confm_time,
			info.cancel_dt,
			info.bigo,  
			info.mber_name,  
			info.company_name,  
			info.biz_num,  
			info.mber_mobile, 
			info.mber_phone, 
			info.calculate_type  
		 FROM ( 
			SELECT ROW_NUMBER() OVER(ORDER BY b.confm_dt DESC,b.confm_time DESC) AS rnum,
				d.cmpnm,
				e.adres,
				e.biz_type_name,
				e.biz_item,
				d.trmnl_no,
				d.pg_trmnl_no,
				d.pg_van,
				c.usid, 
				case e.pay_type when 'N' then '일반' else ( case e.pay_type  when 'B' then '바로정산' else '익일입금' end ) end as pay_type, 
				b.rcipt_no,
				(SELECT adi_cn 
					FROM delng_adi 
					WHERE mber_code=b.mber_code 
						AND mber_code_sn=b.mber_code_sn 
						AND rcipt_no=b.rcipt_no 
						AND adi_code='PURCHSR_MBTLNUM') AS purchsr_mbtlnum,
				b.splpc,
				b.vat,
				b.delng_se_code,
				a.card_type,
				a.instlmt_month,
				a.issue_cmpny_nm,
				a.card_no,
				a.pg_van_gb,
				a.van_pg_comp,
				b.confm_dt,
				b.confm_time,
				b.confm_no,
				b.sms_auth_number,
				b.good_nm,
				b.payment_device,
				(SELECT mbtlnum FROM mber_basis WHERE mber_code=c.mber_code) AS mbtlnum,
				(SELECT confm_dt 
					FROM delng 
					WHERE trget_mber_code=b.mber_code 
					    AND trget_mber_code_sn=b.mber_code_sn 
					    AND trget_rcipt_no=b.rcipt_no 
					    AND delng_se_code IN('CARD_CNCL','CASH_RCIPT_CNCL')) AS cncl_confm_dt,
				(SELECT confm_time 
				    FROM delng 
				    WHERE trget_mber_code=b.mber_code 
				        AND trget_mber_code_sn=b.mber_code_sn 
				        AND trget_rcipt_no=b.rcipt_no 
				        AND delng_se_code IN('CARD_CNCL','CASH_RCIPT_CNCL')) AS cncl_confm_time,
				TO_CHAR(b.cancel_dt,'YYYY-MM-DD') AS cancel_dt,  
				b.bigo,  
				e.mber_name,  
				e.company_name,  
				e.biz_num,  
				e.mber_mobile, 
				e.mber_phone,
				e.calculate_type 
				FROM delng b
		        left outer join delng_credt a
		        on a.mber_code=b.mber_code AND a.mber_code_sn=b.mber_code_sn AND a.rcipt_no=b.rcipt_no 
		        inner join mber c
		        on b.mber_code=c.mber_code 
		        inner join biz d
		        on c.biz_code=d.biz_code
		        right outer join mber_basis e 
		        on c.mber_code =e.mber_code 
				WHERE b.delng_se_code IN('CARD_ISSUE','CARD_CNCL','CASH_RCIPT_CNCL','CASH_RCIPT_ISSUE')
				<include refid="delng" />
				ORDER BY b.confm_dt DESC,b.confm_time DESC 
			) info
			WHERE rnum BETWEEN #{startIndex} AND #{endIndex}
	</select>
	
	<!-- 거래조회 전체갯수 -->
	<select id="totCount" resultType="int">
	SELECT 
		count(1) count
	FROM delng b
	left outer join delng_credt a
	   on a.mber_code=b.mber_code AND a.mber_code_sn=b.mber_code_sn AND a.rcipt_no=b.rcipt_no 
	inner join mber c
	   on b.mber_code=c.mber_code 
	inner join biz d
	   on c.biz_code=d.biz_code
	right outer join mber_basis e 
	   on c.mber_code =e.mber_code 
	WHERE b.delng_se_code IN('CARD_ISSUE','CARD_CNCL','CASH_RCIPT_CNCL','CASH_RCIPT_ISSUE')
	<include refid="delng" />

	</select>
	
  </mapper>
